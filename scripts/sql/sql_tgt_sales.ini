[query]
load=
 delete from sales.sales_data where ins_dtm is null or ins_dtm < (current_date-30) or ins_dtm like '<ins_dtm>';
 insert INTO sales.sales_data
 select
	order_id ,
	order_date ,
	ship_date,
	ship_mode,
	customer_id,
	customer_name,
	segment,
	country,
	city,
	state,
	postal_code,
	region,
	product_id,
	category,
	sub_category,
	product_name,
	sales,
	quantity,
	discount,
	profit,
	(profit / sales) * 100 as profit_margin,
	TO_CHAR(GETDATE(), 'YYYY-MM-DD HH24:MI:00') as ins_dtm
 from sales.sales_data_stg;
 COMMIT;

unload=UNLOAD(
  $$
  select
  order_id ,
  order_date ,
  ship_date,
  ship_mode,
  customer_id,
  customer_name,
  segment,
  country,
  city,
  state,
  postal_code,
  region,
  product_id,
  category,
  sub_category,
  product_name,
  sales,
  quantity,
  discount,
  profit,
  profit_margin
  ins_dtm
  from sales.sales_data
  where ins_dtm in (select max(a.ins_dtm) from sales.sales_data as a)
  $$
  )
  TO '<s3_path>'
  credentials '<iam_role>'
  ALLOWOVERWRITE
  CSV DELIMITER AS '|'
  Header
  parallel off
  Gzip;
